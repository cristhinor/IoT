<!DOCTYPE html>
<html>
<head>
  <title>Monitor Energ√©tico</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #111;
      font-family: Arial, sans-serif;
      text-align: center;
      color: white;
    }

    h1 {
      margin-top: 20px;
    }

    .panel {
      background-color: #1c1c1c;
      border-radius: 15px;
      padding: 20px;
      width: 80%;
      margin: auto;
      box-shadow: 0 0 20px #00ffcc;
    }

    .valor-actual {
      font-size: 70px;
      margin: 20px 0;
      font-weight: bold;
      transition: 0.3s;
    }

    .estado {
      font-size: 20px;
      margin-bottom: 15px;
    }

    canvas {
      background-color: #222;
      border-radius: 10px;
    }
  </style>
</head>
<body>

<h1>‚ö° Panel Energ√©tico - Casa</h1>

<div class="panel">
  <div>Consumo Actual (kWh)</div>
  <div class="valor-actual" id="valorActual">0.00</div>
  <div class="estado" id="estadoConsumo">Estado: Normal</div>
  <canvas id="grafica"></canvas>
</div>

<script>

const channelID = "3269236";
const readAPIKey = "PDPCE774ZFAWV1SF";

let chart;

function evaluarNivel(valor) {
  const estado = document.getElementById("estadoConsumo");
  const valorTexto = document.getElementById("valorActual");

  if (valor <= 4) {
    valorTexto.style.color = "#00ff00";
    estado.innerText = "Estado: üü¢ Consumo Normal";
    estado.style.color = "#00ff00";
  } 
  else if (valor <= 7) {
    valorTexto.style.color = "#ffff00";
    estado.innerText = "Estado: üü° Consumo Alto";
    estado.style.color = "#ffff00";
  } 
  else {
    valorTexto.style.color = "#ff0000";
    estado.innerText = "Estado: üî¥ Consumo Cr√≠tico";
    estado.style.color = "#ff0000";
  }
}

function cargarDatos() {

  fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=20`)
    .then(response => response.json())
    .then(data => {

      const valores = data.feeds.map(d => parseFloat(d.field1));
      const fechas = data.feeds.map(d => new Date(d.created_at).toLocaleTimeString());

      const ultimoValor = valores[valores.length - 1];
      document.getElementById("valorActual").innerText = ultimoValor.toFixed(2);

      evaluarNivel(ultimoValor);

      if (!chart) {
        chart = new Chart(document.getElementById("grafica"), {
          type: "line",
          data: {
            labels: fechas,
            datasets: [{
              label: "Energ√≠a (kWh)",
              data: valores,
              borderColor: "#00ffcc",
              backgroundColor: "rgba(0,255,204,0.1)",
              borderWidth: 2,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              x: { ticks: { color: "white" } },
              y: { ticks: { color: "white" } }
            },
            plugins: {
              legend: {
                labels: { color: "white" }
              }
            }
          }
        });
      } else {
        chart.data.labels = fechas;
        chart.data.datasets[0].data = valores;
        chart.update();
      }

    });
}

cargarDatos();
setInterval(cargarDatos, 5000);

</script>

</body>
</html>